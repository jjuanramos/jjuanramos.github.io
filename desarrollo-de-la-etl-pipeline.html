<!DOCTYPE html>
<html lang="es" xml:lang="es">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>7.1 Desarrollo de la ETL Pipeline | Herramientas de visualización interactivas para la toma de decisiones en una startup tecnológica.</title>
  <meta name="description" content="7.1 Desarrollo de la ETL Pipeline | Herramientas de visualización interactivas para la toma de decisiones en una startup tecnológica." />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="7.1 Desarrollo de la ETL Pipeline | Herramientas de visualización interactivas para la toma de decisiones en una startup tecnológica." />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="7.1 Desarrollo de la ETL Pipeline | Herramientas de visualización interactivas para la toma de decisiones en una startup tecnológica." />
  
  
  

<meta name="author" content="Juan Ramos Hernández, Grado en Administración y dirección de Empresas" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="código.html"/>
<link rel="next" href="desarrollo-de-la-aplicación-en-shiny-1.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/Proj4Leaflet-1.0.1/proj4-compressed.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.3/leaflet.js"></script>
<script src="libs/lfx-heat-0.1.0/lfx-heat-prod.js"></script>
<script src="libs/lfx-heat-0.1.0/lfx-heat-bindings.js"></script>
<script src="libs/plotly-binding-4.9.2/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>
<link href="libs/plotly-htmlwidgets-css-1.52.2/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main-1.52.2/plotly-latest.min.js"></script>
<script src="libs/fuse_js-3.2.0/fuse_js-prod.js"></script>
<link href="libs/lfx-search-2.3.7/lfx-search-prod.css" rel="stylesheet" />
<script src="libs/lfx-search-2.3.7/lfx-search-prod.js"></script>
<script src="libs/lfx-search-2.3.7/lfx-search-bindings.js"></script>
<link href="libs/leaflet-awesomemarkers-2.0.3/leaflet.awesome-markers.css" rel="stylesheet" />
<script src="libs/leaflet-awesomemarkers-2.0.3/leaflet.awesome-markers.min.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Resumen</a></li>
<li class="chapter" data-level="1" data-path="introducción.html"><a href="introducción.html"><i class="fa fa-check"></i><b>1</b> Introducción</a><ul>
<li class="chapter" data-level="1.1" data-path="qué-es-homyspace.html"><a href="qué-es-homyspace.html"><i class="fa fa-check"></i><b>1.1</b> ¿Qué es homyspace?</a></li>
<li class="chapter" data-level="1.2" data-path="definiciones.html"><a href="definiciones.html"><i class="fa fa-check"></i><b>1.2</b> Definiciones</a><ul>
<li class="chapter" data-level="1.2.1" data-path="definiciones.html"><a href="definiciones.html#conceptos-relacionados-con-el-mundo-start-up"><i class="fa fa-check"></i><b>1.2.1</b> Conceptos relacionados con el mundo start-up</a></li>
<li class="chapter" data-level="1.2.2" data-path="definiciones.html"><a href="definiciones.html#conceptos-relacionados-con-homyspace"><i class="fa fa-check"></i><b>1.2.2</b> Conceptos relacionados con homyspace</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="flujo-de-trabajo-de-homyspace.html"><a href="flujo-de-trabajo-de-homyspace.html"><i class="fa fa-check"></i><b>1.3</b> Flujo de trabajo de homyspace</a><ul>
<li class="chapter" data-level="1.3.1" data-path="flujo-de-trabajo-de-homyspace.html"><a href="flujo-de-trabajo-de-homyspace.html#flujo-de-proveedores"><i class="fa fa-check"></i><b>1.3.1</b> Flujo de Proveedores</a></li>
<li class="chapter" data-level="1.3.2" data-path="flujo-de-trabajo-de-homyspace.html"><a href="flujo-de-trabajo-de-homyspace.html#flujo-de-empresas"><i class="fa fa-check"></i><b>1.3.2</b> Flujo de Empresas</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="objetivos.html"><a href="objetivos.html"><i class="fa fa-check"></i><b>2</b> Objetivos</a><ul>
<li class="chapter" data-level="2.1" data-path="objetivo-general.html"><a href="objetivo-general.html"><i class="fa fa-check"></i><b>2.1</b> Objetivo General</a></li>
<li class="chapter" data-level="2.2" data-path="objetivos-específicos.html"><a href="objetivos-específicos.html"><i class="fa fa-check"></i><b>2.2</b> Objetivos Específicos</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="aplicación-de-gráficos-interactivos-para-la-toma-de-decisiones.html"><a href="aplicación-de-gráficos-interactivos-para-la-toma-de-decisiones.html"><i class="fa fa-check"></i><b>3</b> Aplicación de gráficos interactivos para la toma de decisiones</a><ul>
<li class="chapter" data-level="3.1" data-path="qué-es-un-gráfico-interactivo.html"><a href="qué-es-un-gráfico-interactivo.html"><i class="fa fa-check"></i><b>3.1</b> ¿Qué es un gráfico interactivo?</a></li>
<li class="chapter" data-level="3.2" data-path="ventajas-de-los-gráficos-interactivos-frente-a-los-estáticos.html"><a href="ventajas-de-los-gráficos-interactivos-frente-a-los-estáticos.html"><i class="fa fa-check"></i><b>3.2</b> Ventajas de los gráficos interactivos frente a los estáticos</a><ul>
<li class="chapter" data-level="3.2.1" data-path="ventajas-de-los-gráficos-interactivos-frente-a-los-estáticos.html"><a href="ventajas-de-los-gráficos-interactivos-frente-a-los-estáticos.html#inconvenientes-de-los-gráficos-interactivos"><i class="fa fa-check"></i><b>3.2.1</b> Inconvenientes de los gráficos interactivos</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="aplicación-de-gráficos-interactivos-para-la-toma-de-decisiones-aspecto-y-componentes.html"><a href="aplicación-de-gráficos-interactivos-para-la-toma-de-decisiones-aspecto-y-componentes.html"><i class="fa fa-check"></i><b>3.3</b> Aplicación de gráficos interactivos para la toma de decisiones: aspecto y componentes</a></li>
<li class="chapter" data-level="3.4" data-path="aplicación-en-el-equipo-de-proveedores.html"><a href="aplicación-en-el-equipo-de-proveedores.html"><i class="fa fa-check"></i><b>3.4</b> Aplicación en el equipo de proveedores</a><ul>
<li class="chapter" data-level="3.4.1" data-path="aplicación-en-el-equipo-de-proveedores.html"><a href="aplicación-en-el-equipo-de-proveedores.html#métodos-para-la-difusión-del-uso-de-la-aplicación"><i class="fa fa-check"></i><b>3.4.1</b> Métodos para la difusión del uso de la aplicación</a></li>
<li class="chapter" data-level="3.4.2" data-path="aplicación-en-el-equipo-de-proveedores.html"><a href="aplicación-en-el-equipo-de-proveedores.html#captación"><i class="fa fa-check"></i><b>3.4.2</b> Captación</a></li>
<li class="chapter" data-level="3.4.3" data-path="aplicación-en-el-equipo-de-proveedores.html"><a href="aplicación-en-el-equipo-de-proveedores.html#negociación"><i class="fa fa-check"></i><b>3.4.3</b> Negociación</a></li>
<li class="chapter" data-level="3.4.4" data-path="aplicación-en-el-equipo-de-proveedores.html"><a href="aplicación-en-el-equipo-de-proveedores.html#curación"><i class="fa fa-check"></i><b>3.4.4</b> Curación</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="aplicación-como-herramienta-de-inversión.html"><a href="aplicación-como-herramienta-de-inversión.html"><i class="fa fa-check"></i><b>3.5</b> Aplicación como herramienta de inversión</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="desarrollo-de-la-aplicación.html"><a href="desarrollo-de-la-aplicación.html"><i class="fa fa-check"></i><b>4</b> Desarrollo de la aplicación</a><ul>
<li class="chapter" data-level="4.1" data-path="fuente-de-datos.html"><a href="fuente-de-datos.html"><i class="fa fa-check"></i><b>4.1</b> Fuente de datos</a><ul>
<li class="chapter" data-level="4.1.1" data-path="fuente-de-datos.html"><a href="fuente-de-datos.html#introducción-1"><i class="fa fa-check"></i><b>4.1.1</b> Introducción</a></li>
<li class="chapter" data-level="4.1.2" data-path="fuente-de-datos.html"><a href="fuente-de-datos.html#etl-pipeline-definición"><i class="fa fa-check"></i><b>4.1.2</b> ETL Pipeline: Definición</a></li>
<li class="chapter" data-level="4.1.3" data-path="fuente-de-datos.html"><a href="fuente-de-datos.html#orígenes-de-datos"><i class="fa fa-check"></i><b>4.1.3</b> Orígenes de datos</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="diseño-de-la-pipeline.html"><a href="diseño-de-la-pipeline.html"><i class="fa fa-check"></i><b>4.2</b> Diseño de la Pipeline</a></li>
<li class="chapter" data-level="4.3" data-path="desarrollo-de-la-pipeline.html"><a href="desarrollo-de-la-pipeline.html"><i class="fa fa-check"></i><b>4.3</b> Desarrollo de la Pipeline</a><ul>
<li class="chapter" data-level="4.3.1" data-path="desarrollo-de-la-pipeline.html"><a href="desarrollo-de-la-pipeline.html#extracción-extract"><i class="fa fa-check"></i><b>4.3.1</b> Extracción (extract)</a></li>
<li class="chapter" data-level="4.3.2" data-path="desarrollo-de-la-pipeline.html"><a href="desarrollo-de-la-pipeline.html#transformación-transform"><i class="fa fa-check"></i><b>4.3.2</b> Transformación (transform)</a></li>
<li class="chapter" data-level="4.3.3" data-path="desarrollo-de-la-pipeline.html"><a href="desarrollo-de-la-pipeline.html#carga-load"><i class="fa fa-check"></i><b>4.3.3</b> Carga (load)</a></li>
<li class="chapter" data-level="4.3.4" data-path="desarrollo-de-la-pipeline.html"><a href="desarrollo-de-la-pipeline.html#arquitectura-final-y-gestión-de-su-actualización"><i class="fa fa-check"></i><b>4.3.4</b> Arquitectura final y gestión de su actualización</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="gráficos-interactivos.html"><a href="gráficos-interactivos.html"><i class="fa fa-check"></i><b>4.4</b> Gráficos Interactivos</a><ul>
<li class="chapter" data-level="4.4.1" data-path="gráficos-interactivos.html"><a href="gráficos-interactivos.html#introducción-2"><i class="fa fa-check"></i><b>4.4.1</b> Introducción</a></li>
<li class="chapter" data-level="4.4.2" data-path="gráficos-interactivos.html"><a href="gráficos-interactivos.html#componentes"><i class="fa fa-check"></i><b>4.4.2</b> Componentes</a></li>
<li class="chapter" data-level="4.4.3" data-path="gráficos-interactivos.html"><a href="gráficos-interactivos.html#reactividad-en-shiny-qué-es-y-cómo-aprovecharla"><i class="fa fa-check"></i><b>4.4.3</b> Reactividad en Shiny: qué es y cómo aprovecharla</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="desarrollo-de-la-aplicación-en-shiny.html"><a href="desarrollo-de-la-aplicación-en-shiny.html"><i class="fa fa-check"></i><b>4.5</b> Desarrollo de la aplicación en Shiny</a><ul>
<li class="chapter" data-level="4.5.1" data-path="desarrollo-de-la-aplicación-en-shiny.html"><a href="desarrollo-de-la-aplicación-en-shiny.html#carga-de-librerías"><i class="fa fa-check"></i><b>4.5.1</b> Carga de librerías</a></li>
<li class="chapter" data-level="4.5.2" data-path="desarrollo-de-la-aplicación-en-shiny.html"><a href="desarrollo-de-la-aplicación-en-shiny.html#creación-de-funciones"><i class="fa fa-check"></i><b>4.5.2</b> Creación de funciones</a></li>
<li class="chapter" data-level="4.5.3" data-path="desarrollo-de-la-aplicación-en-shiny.html"><a href="desarrollo-de-la-aplicación-en-shiny.html#carga-y-transformación-de-los-datos"><i class="fa fa-check"></i><b>4.5.3</b> Carga y transformación de los datos</a></li>
<li class="chapter" data-level="4.5.4" data-path="desarrollo-de-la-aplicación-en-shiny.html"><a href="desarrollo-de-la-aplicación-en-shiny.html#desarrollo-de-la-interfaz-de-usuario"><i class="fa fa-check"></i><b>4.5.4</b> Desarrollo de la interfaz de usuario</a></li>
<li class="chapter" data-level="4.5.5" data-path="desarrollo-de-la-aplicación-en-shiny.html"><a href="desarrollo-de-la-aplicación-en-shiny.html#desarrollo-de-los-gráficos-y-de-la-reactividad"><i class="fa fa-check"></i><b>4.5.5</b> Desarrollo de los gráficos y de la reactividad</a></li>
<li class="chapter" data-level="4.5.6" data-path="desarrollo-de-la-aplicación-en-shiny.html"><a href="desarrollo-de-la-aplicación-en-shiny.html#publicación-de-la-aplicación"><i class="fa fa-check"></i><b>4.5.6</b> Publicación de la aplicación</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="aspecto-final.html"><a href="aspecto-final.html"><i class="fa fa-check"></i><b>4.6</b> Aspecto Final</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="conclusión.html"><a href="conclusión.html"><i class="fa fa-check"></i><b>5</b> Conclusión</a><ul>
<li class="chapter" data-level="5.1" data-path="aprendizajes.html"><a href="aprendizajes.html"><i class="fa fa-check"></i><b>5.1</b> Aprendizajes</a></li>
<li class="chapter" data-level="5.2" data-path="a-mejorar.html"><a href="a-mejorar.html"><i class="fa fa-check"></i><b>5.2</b> A mejorar</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="índice-de-figuras.html"><a href="índice-de-figuras.html"><i class="fa fa-check"></i><b>6</b> Índice de figuras</a></li>
<li class="chapter" data-level="7" data-path="código.html"><a href="código.html"><i class="fa fa-check"></i><b>7</b> Código</a><ul>
<li class="chapter" data-level="7.1" data-path="desarrollo-de-la-etl-pipeline.html"><a href="desarrollo-de-la-etl-pipeline.html"><i class="fa fa-check"></i><b>7.1</b> Desarrollo de la ETL Pipeline</a></li>
<li class="chapter" data-level="7.2" data-path="desarrollo-de-la-aplicación-en-shiny-1.html"><a href="desarrollo-de-la-aplicación-en-shiny-1.html"><i class="fa fa-check"></i><b>7.2</b> Desarrollo de la aplicación en Shiny</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="referencias.html"><a href="referencias.html"><i class="fa fa-check"></i>Referencias</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Herramientas de visualización interactivas para la toma de decisiones en una startup tecnológica.</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<html>
<img src='images/fadeupv.jpg' alt="FADE">
</html>
<div id="desarrollo-de-la-etl-pipeline" class="section level2">
<h2><span class="header-section-number">7.1</span> Desarrollo de la ETL Pipeline</h2>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb7-1" title="1"><span class="im">import</span> os</a>
<a class="sourceLine" id="cb7-2" title="2"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb7-3" title="3"><span class="im">import</span> geopandas <span class="im">as</span> gpd</a>
<a class="sourceLine" id="cb7-4" title="4"><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</a>
<a class="sourceLine" id="cb7-5" title="5"><span class="im">import</span> matplotlib.lines <span class="im">as</span> mlines</a>
<a class="sourceLine" id="cb7-6" title="6"><span class="im">from</span> matplotlib.colors <span class="im">import</span> ListedColormap</a>
<a class="sourceLine" id="cb7-7" title="7"><span class="im">import</span> earthpy <span class="im">as</span> et </a>
<a class="sourceLine" id="cb7-8" title="8">distritos <span class="op">=</span> gpd.read_file(<span class="st">&quot;distritos.shp&quot;</span>, SHAPE_RESTORE_SHX <span class="op">=</span> <span class="st">&quot;YES&quot;</span>) <span class="co"># distritos.shp es el</span></a>
<a class="sourceLine" id="cb7-9" title="9"><span class="co"># documento descargado del INE</span></a>
<a class="sourceLine" id="cb7-10" title="10">distritos_df <span class="op">=</span> distritos.dissolve(by<span class="op">=</span><span class="st">&quot;CUDIS&quot;</span>) <span class="co"># disolvemos por distrito</span></a>
<a class="sourceLine" id="cb7-11" title="11">distritos_df <span class="op">=</span> distritos_df.reset_index()</a>
<a class="sourceLine" id="cb7-12" title="12"><span class="co">#Guardamos el archivo diferenciado por distritos a Shapefile</span></a>
<a class="sourceLine" id="cb7-13" title="13">distritos_df.to_file(<span class="st">&quot;coordenadasDistritos.shp&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb8-1" title="1"><span class="im">from</span> elasticsearch <span class="im">import</span> Elasticsearch, RequestsHttpConnection</a>
<a class="sourceLine" id="cb8-2" title="2"><span class="im">from</span> elasticsearch_dsl <span class="im">import</span> Search, Q</a>
<a class="sourceLine" id="cb8-3" title="3"><span class="im">from</span> requests_aws4auth <span class="im">import</span> AWS4Auth</a>
<a class="sourceLine" id="cb8-4" title="4"><span class="im">import</span> pandas <span class="im">as</span> pd</a>
<a class="sourceLine" id="cb8-5" title="5"></a>
<a class="sourceLine" id="cb8-6" title="6"><span class="kw">def</span> getData(index, fields, query<span class="op">=</span><span class="va">None</span>, endpoint <span class="op">=</span> endpoint):</a>
<a class="sourceLine" id="cb8-7" title="7">    <span class="co"># index es el índice al que vamos a llamar.</span></a>
<a class="sourceLine" id="cb8-8" title="8">    <span class="co"># fields, los campos que queremos extraer.</span></a>
<a class="sourceLine" id="cb8-9" title="9">    <span class="co"># query es el filtro que podemos aplicar. Por defecto, no aplicamos filtro.</span></a>
<a class="sourceLine" id="cb8-10" title="10">    <span class="co"># endpoint es la api a través de la cual nos conectamos a Elasticsearch.</span></a>
<a class="sourceLine" id="cb8-11" title="11">    access_key <span class="op">=</span> accessKey</a>
<a class="sourceLine" id="cb8-12" title="12">    secret_key <span class="op">=</span> secretKey</a>
<a class="sourceLine" id="cb8-13" title="13">    auth<span class="op">=</span>AWS4Auth(access_key, secret_key, region, service)</a>
<a class="sourceLine" id="cb8-14" title="14">    <span class="co"># En Homyspace, Elasticsearch se utiliza como servicio gestionado a través</span></a>
<a class="sourceLine" id="cb8-15" title="15">    <span class="co"># de Amazon Web Services, de ahí que necesitemos una autentificación adaptada.</span></a>
<a class="sourceLine" id="cb8-16" title="16">    <span class="co"># Region es la región que vamos a utilizar de AWS, y service el servicio,</span></a>
<a class="sourceLine" id="cb8-17" title="17">    <span class="co"># en este caso Elasticsearch.</span></a>
<a class="sourceLine" id="cb8-18" title="18"></a>
<a class="sourceLine" id="cb8-19" title="19">    es <span class="op">=</span> Elasticsearch(</a>
<a class="sourceLine" id="cb8-20" title="20">        hosts <span class="op">=</span> [{<span class="st">&quot;host&quot;</span>: endpoint, <span class="st">&quot;port&quot;</span>: port}],</a>
<a class="sourceLine" id="cb8-21" title="21">        http_auth<span class="op">=</span>auth,</a>
<a class="sourceLine" id="cb8-22" title="22">        use_ssl<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb8-23" title="23">        verify_certs<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb8-24" title="24">        connection_class<span class="op">=</span>RequestsHttpConnection</a>
<a class="sourceLine" id="cb8-25" title="25">    )</a>
<a class="sourceLine" id="cb8-26" title="26">    </a>
<a class="sourceLine" id="cb8-27" title="27">    <span class="cf">if</span> <span class="kw">not</span> query:</a>
<a class="sourceLine" id="cb8-28" title="28">        indexQuery <span class="op">=</span> Search(using<span class="op">=</span>es, index<span class="op">=</span>index).source(includes<span class="op">=</span>fields)</a>
<a class="sourceLine" id="cb8-29" title="29">        data <span class="op">=</span> pd.DataFrame((d.to_dict() <span class="cf">for</span> d <span class="kw">in</span> indexQuery.scan()))</a>
<a class="sourceLine" id="cb8-30" title="30">    <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb8-31" title="31">        indexQuery <span class="op">=</span> Search(using<span class="op">=</span>es, index<span class="op">=</span>index).source(includes<span class="op">=</span>fields)<span class="op">\</span></a>
<a class="sourceLine" id="cb8-32" title="32">        .query(<span class="st">&quot;bool&quot;</span>, <span class="bu">filter</span> <span class="op">=</span> query)</a>
<a class="sourceLine" id="cb8-33" title="33">        data <span class="op">=</span> pd.DataFrame((d.to_dict() <span class="cf">for</span> d <span class="kw">in</span> indexQuery.scan()))</a>
<a class="sourceLine" id="cb8-34" title="34">        </a>
<a class="sourceLine" id="cb8-35" title="35">    <span class="co"># Por último, transforma la respuesta en una matriz de datos que pueda ser utilizada</span></a>
<a class="sourceLine" id="cb8-36" title="36">    <span class="co"># en Python, y la devuelve</span></a>
<a class="sourceLine" id="cb8-37" title="37">    <span class="cf">return</span> data  </a></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb9-1" title="1"><span class="im">from</span> elasticsearch <span class="im">import</span> Elasticsearch, RequestsHttpConnection</a>
<a class="sourceLine" id="cb9-2" title="2"><span class="im">from</span> elasticsearch_dsl <span class="im">import</span> Search, Q</a>
<a class="sourceLine" id="cb9-3" title="3"><span class="im">from</span> requests_aws4auth <span class="im">import</span> AWS4Auth</a>
<a class="sourceLine" id="cb9-4" title="4"><span class="im">import</span> dropbox</a>
<a class="sourceLine" id="cb9-5" title="5"><span class="im">from</span> dropbox.files <span class="im">import</span> WriteMode</a>
<a class="sourceLine" id="cb9-6" title="6"><span class="im">from</span> dropbox.exceptions <span class="im">import</span> ApiError, AuthError</a>
<a class="sourceLine" id="cb9-7" title="7"><span class="im">import</span> requests</a>
<a class="sourceLine" id="cb9-8" title="8"><span class="im">import</span> zipfile, io</a>
<a class="sourceLine" id="cb9-9" title="9"><span class="im">from</span> zipfile <span class="im">import</span> ZipFile</a>
<a class="sourceLine" id="cb9-10" title="10"><span class="im">import</span> pandas <span class="im">as</span> pd</a>
<a class="sourceLine" id="cb9-11" title="11"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb9-12" title="12"><span class="im">import</span> geopandas <span class="im">as</span> gpd</a>
<a class="sourceLine" id="cb9-13" title="13"><span class="im">from</span> shapely.geometry <span class="im">import</span> Point</a></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb10-1" title="1">endpoint <span class="op">=</span> endpoint</a>
<a class="sourceLine" id="cb10-2" title="2">access_key <span class="op">=</span> access_key</a>
<a class="sourceLine" id="cb10-3" title="3">secret_key <span class="op">=</span> secret_key</a>
<a class="sourceLine" id="cb10-4" title="4">auth<span class="op">=</span>AWS4Auth(access_key, secret_key, region, <span class="st">&quot;es&quot;</span>)</a>
<a class="sourceLine" id="cb10-5" title="5"></a>
<a class="sourceLine" id="cb10-6" title="6">es <span class="op">=</span> Elasticsearch(</a>
<a class="sourceLine" id="cb10-7" title="7">    hosts <span class="op">=</span> [{<span class="st">&quot;host&quot;</span>: endpoint, <span class="st">&quot;port&quot;</span>: <span class="dv">443</span>}],</a>
<a class="sourceLine" id="cb10-8" title="8">    http_auth<span class="op">=</span>auth,</a>
<a class="sourceLine" id="cb10-9" title="9">    use_ssl<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb10-10" title="10">    verify_certs<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb10-11" title="11">    connection_class<span class="op">=</span>RequestsHttpConnection</a>
<a class="sourceLine" id="cb10-12" title="12">)</a></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">def</span> getPropertiesData():</a>
<a class="sourceLine" id="cb11-2" title="2">    s1 <span class="op">=</span> Search(using<span class="op">=</span>es, index<span class="op">=</span><span class="st">&quot;property&quot;</span>).source(includes<span class="op">=</span></a>
<a class="sourceLine" id="cb11-3" title="3">    [<span class="st">&quot;address.locality&quot;</span>,</a>
<a class="sourceLine" id="cb11-4" title="4">    <span class="st">&quot;address.administrativeAreaLevel2&quot;</span>,</a>
<a class="sourceLine" id="cb11-5" title="5">    <span class="st">&quot;address.country&quot;</span>,</a>
<a class="sourceLine" id="cb11-6" title="6">    <span class="st">&quot;id&quot;</span>,</a>
<a class="sourceLine" id="cb11-7" title="7">    <span class="st">&quot;address.geoLocation&quot;</span>]</a>
<a class="sourceLine" id="cb11-8" title="8">    )</a>
<a class="sourceLine" id="cb11-9" title="9">    </a>
<a class="sourceLine" id="cb11-10" title="10">    propertiesData <span class="op">=</span> pd.DataFrame((d.to_dict() <span class="cf">for</span> d <span class="kw">in</span> s1.scan()))</a>
<a class="sourceLine" id="cb11-11" title="11">    propertiesData[<span class="st">&quot;country&quot;</span>] <span class="op">=</span> propertiesData.address.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.get(<span class="st">&quot;country&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-12" title="12">     <span class="cf">if</span> <span class="bu">type</span>(x) <span class="kw">is</span> <span class="kw">not</span> <span class="bu">float</span> <span class="cf">else</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb11-13" title="13">    propertiesData[<span class="st">&quot;province&quot;</span>] <span class="op">=</span> propertiesData.address.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.get<span class="op">\</span></a>
<a class="sourceLine" id="cb11-14" title="14">    (<span class="st">&quot;administrativeAreaLevel2&quot;</span>) <span class="cf">if</span> <span class="bu">type</span>(x) <span class="kw">is</span> <span class="kw">not</span> <span class="bu">float</span> <span class="cf">else</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb11-15" title="15">    propertiesData <span class="op">=</span> propertiesData[propertiesData.country <span class="op">==</span> <span class="st">&quot;España&quot;</span>]</a>
<a class="sourceLine" id="cb11-16" title="16">    propertiesData(columns<span class="op">=</span>{<span class="st">&quot;id&quot;</span>: <span class="st">&quot;propertyId&quot;</span>}, inplace <span class="op">=</span> <span class="va">True</span>)</a>
<a class="sourceLine" id="cb11-17" title="17">    propertiesData[<span class="st">&quot;lon&quot;</span>] <span class="op">=</span> propertiesData.address.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.get(<span class="st">&quot;geoLocation&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-18" title="18">    .get(<span class="st">&quot;lon&quot;</span>) <span class="cf">if</span> <span class="bu">type</span>(x) <span class="kw">is</span> <span class="kw">not</span> <span class="bu">float</span> <span class="cf">else</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb11-19" title="19">    propertiesData[<span class="st">&quot;lat&quot;</span>] <span class="op">=</span> propertiesData.address.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.get(<span class="st">&quot;geoLocation&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-20" title="20">    .get(<span class="st">&quot;lat&quot;</span>) <span class="cf">if</span> <span class="bu">type</span>(x) <span class="kw">is</span> <span class="kw">not</span> <span class="bu">float</span> <span class="cf">else</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb11-21" title="21">    propertiesData[<span class="st">&quot;propertyCity&quot;</span>] <span class="op">=</span> propertiesData.address.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.get(<span class="st">&quot;locality&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-22" title="22">    <span class="cf">if</span> <span class="bu">type</span>(x) <span class="kw">is</span> <span class="kw">not</span> <span class="bu">float</span> <span class="cf">else</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb11-23" title="23">    propertiesData <span class="op">=</span> propertiesData.replace(<span class="st">&quot;Á&quot;</span>, <span class="st">&quot;A&quot;</span>).replace(<span class="st">&quot;á&quot;</span>, <span class="st">&quot;a&quot;</span>).replace(<span class="st">&quot;À&quot;</span>, <span class="st">&quot;A&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-24" title="24">    .replace(<span class="st">&quot;à&quot;</span>, <span class="st">&quot;a&quot;</span>).replace(<span class="st">&quot;É&quot;</span>, <span class="st">&quot;E&quot;</span>).replace(<span class="st">&quot;é&quot;</span>, <span class="st">&quot;e&quot;</span>).replace(<span class="st">&quot;È&quot;</span>, <span class="st">&quot;E&quot;</span>).replace(<span class="st">&quot;è&quot;</span>, <span class="st">&quot;e&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-25" title="25">    .replace(<span class="st">&quot;Í&quot;</span>, <span class="st">&quot;I&quot;</span>).replace(<span class="st">&quot;í&quot;</span>, <span class="st">&quot;i&quot;</span>).replace(<span class="st">&quot;Ì&quot;</span>, <span class="st">&quot;I&quot;</span>).replace(<span class="st">&quot;ì&quot;</span>, <span class="st">&quot;i&quot;</span>).replace(<span class="st">&quot;Ó&quot;</span>, <span class="st">&quot;O&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-26" title="26">    .replace(<span class="st">&quot;ó&quot;</span>, <span class="st">&quot;o&quot;</span>).replace(<span class="st">&quot;Ò&quot;</span>, <span class="st">&quot;O&quot;</span>).replace(<span class="st">&quot;ò&quot;</span>, <span class="st">&quot;o&quot;</span>).replace(<span class="st">&quot;Ú&quot;</span>,<span class="st">&quot;U&quot;</span>).replace(<span class="st">&quot;ú&quot;</span>, <span class="st">&quot;u&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-27" title="27">    .replace(<span class="st">&quot;Ù&quot;</span>, <span class="st">&quot;U&quot;</span>).replace(<span class="st">&quot;ù&quot;</span>, <span class="st">&quot;u&quot;</span>).replace(<span class="st">&quot;Ñ&quot;</span>, <span class="st">&quot;NY&quot;</span>).replace(<span class="st">&quot;ñ&quot;</span>, <span class="st">&quot;ny&quot;</span>).replace(<span class="st">&quot;Ü&quot;</span>, <span class="st">&quot;U&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-28" title="28">    .replace(<span class="st">&quot;ü&quot;</span>, <span class="st">&quot;u&quot;</span>)</a>
<a class="sourceLine" id="cb11-29" title="29">    </a>
<a class="sourceLine" id="cb11-30" title="30">    propertiesData <span class="op">=</span> propertiesData.drop([<span class="st">&quot;address&quot;</span>, <span class="st">&quot;country&quot;</span>], axis<span class="op">=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb11-31" title="31">    geometry <span class="op">=</span> propertiesData.<span class="bu">apply</span>(<span class="kw">lambda</span> x: Point(x.lon, x.lat), axis <span class="op">=</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb11-32" title="32">    propertiesData <span class="op">=</span> gpd.GeoDataFrame(propertiesData, geometry <span class="op">=</span> geometry)</a>
<a class="sourceLine" id="cb11-33" title="33">    </a>
<a class="sourceLine" id="cb11-34" title="34">    <span class="cf">return</span> propertiesData</a>
<a class="sourceLine" id="cb11-35" title="35">    </a>
<a class="sourceLine" id="cb11-36" title="36"><span class="kw">def</span> getOpportunitiesData():</a>
<a class="sourceLine" id="cb11-37" title="37">    s1 <span class="op">=</span> Search(using<span class="op">=</span>es, index<span class="op">=</span><span class="st">&quot;deal*&quot;</span>).source(includes<span class="op">=</span></a>
<a class="sourceLine" id="cb11-38" title="38">    [<span class="st">&quot;address.locality&quot;</span>,</a>
<a class="sourceLine" id="cb11-39" title="39">    <span class="st">&quot;address.administrativeAreaLevel2&quot;</span>,</a>
<a class="sourceLine" id="cb11-40" title="40">    <span class="st">&quot;rentalRequestStage&quot;</span>,</a>
<a class="sourceLine" id="cb11-41" title="41">    <span class="st">&quot;address.country&quot;</span>,</a>
<a class="sourceLine" id="cb11-42" title="42">    <span class="st">&quot;id&quot;</span>,</a>
<a class="sourceLine" id="cb11-43" title="43">    <span class="st">&quot;address.geoLocation&quot;</span>]</a>
<a class="sourceLine" id="cb11-44" title="44">    )</a>
<a class="sourceLine" id="cb11-45" title="45">    opportunitiesData <span class="op">=</span> pd.DataFrame((d.to_dict() <span class="cf">for</span> d <span class="kw">in</span> s1.scan()))</a>
<a class="sourceLine" id="cb11-46" title="46">    opportunitiesData[<span class="st">&quot;country&quot;</span>] <span class="op">=</span> opportunitiesData.address.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.get(<span class="st">&quot;country&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-47" title="47">    <span class="cf">if</span> <span class="bu">type</span>(x) <span class="kw">is</span> <span class="kw">not</span> <span class="bu">float</span> <span class="cf">else</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb11-48" title="48">    opportunitiesData[<span class="st">&quot;province&quot;</span>] <span class="op">=</span> opportunitiesData.address.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.get<span class="op">\</span></a>
<a class="sourceLine" id="cb11-49" title="49">    (<span class="st">&quot;administrativeAreaLevel2&quot;</span>) <span class="cf">if</span> <span class="bu">type</span>(x) <span class="kw">is</span> <span class="kw">not</span> <span class="bu">float</span> <span class="cf">else</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb11-50" title="50">    opportunitiesData <span class="op">=</span> opportunitiesData[opportunitiesData.country <span class="op">==</span> <span class="st">&quot;España&quot;</span>]</a>
<a class="sourceLine" id="cb11-51" title="51">    opportunitiesData[<span class="st">&quot;lon&quot;</span>] <span class="op">=</span> opportunitiesData.address.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.get(<span class="st">&quot;geoLocation&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-52" title="52">    .get(<span class="st">&quot;lon&quot;</span>) <span class="cf">if</span> <span class="bu">type</span>(x) <span class="kw">is</span> <span class="kw">not</span> <span class="bu">float</span> <span class="cf">else</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb11-53" title="53">    opportunitiesData[<span class="st">&quot;lat&quot;</span>] <span class="op">=</span> opportunitiesData.address.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.get(<span class="st">&quot;geoLocation&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-54" title="54">    .get(<span class="st">&quot;lat&quot;</span>) <span class="cf">if</span> <span class="bu">type</span>(x) <span class="kw">is</span> <span class="kw">not</span> <span class="bu">float</span> <span class="cf">else</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb11-55" title="55">    opportunitiesData <span class="op">=</span> opportunitiesData.replace(<span class="st">&quot;Á&quot;</span>, <span class="st">&quot;A&quot;</span>).replace(<span class="st">&quot;á&quot;</span>, <span class="st">&quot;a&quot;</span>).replace(<span class="st">&quot;À&quot;</span>, <span class="st">&quot;A&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-56" title="56">    .replace(<span class="st">&quot;à&quot;</span>, <span class="st">&quot;a&quot;</span>).replace(<span class="st">&quot;É&quot;</span>, <span class="st">&quot;E&quot;</span>).replace(<span class="st">&quot;é&quot;</span>, <span class="st">&quot;e&quot;</span>).replace(<span class="st">&quot;È&quot;</span>, <span class="st">&quot;E&quot;</span>).replace(<span class="st">&quot;è&quot;</span>, <span class="st">&quot;e&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-57" title="57">    .replace(<span class="st">&quot;Í&quot;</span>, <span class="st">&quot;I&quot;</span>).replace(<span class="st">&quot;í&quot;</span>, <span class="st">&quot;i&quot;</span>).replace(<span class="st">&quot;Ì&quot;</span>, <span class="st">&quot;I&quot;</span>).replace(<span class="st">&quot;ì&quot;</span>, <span class="st">&quot;i&quot;</span>).replace(<span class="st">&quot;Ó&quot;</span>, <span class="st">&quot;O&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-58" title="58">    .replace(<span class="st">&quot;ó&quot;</span>, <span class="st">&quot;o&quot;</span>).replace(<span class="st">&quot;Ò&quot;</span>, <span class="st">&quot;O&quot;</span>).replace(<span class="st">&quot;ò&quot;</span>, <span class="st">&quot;o&quot;</span>).replace(<span class="st">&quot;Ú&quot;</span>,<span class="st">&quot;U&quot;</span>).replace(<span class="st">&quot;ú&quot;</span>, <span class="st">&quot;u&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-59" title="59">    .replace(<span class="st">&quot;Ù&quot;</span>, <span class="st">&quot;U&quot;</span>).replace(<span class="st">&quot;ù&quot;</span>, <span class="st">&quot;u&quot;</span>).replace(<span class="st">&quot;Ñ&quot;</span>, <span class="st">&quot;NY&quot;</span>).replace(<span class="st">&quot;ñ&quot;</span>, <span class="st">&quot;ny&quot;</span>).replace(<span class="st">&quot;Ü&quot;</span>, <span class="st">&quot;U&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-60" title="60">    .replace(<span class="st">&quot;ü&quot;</span>, <span class="st">&quot;u&quot;</span>)</a>
<a class="sourceLine" id="cb11-61" title="61">    </a>
<a class="sourceLine" id="cb11-62" title="62">    opportunitiesData <span class="op">=</span> opportunitiesData.drop([<span class="st">&quot;address&quot;</span>, <span class="st">&quot;country&quot;</span>], axis<span class="op">=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb11-63" title="63">    geometry <span class="op">=</span> opportunitiesData.<span class="bu">apply</span>(<span class="kw">lambda</span> x: Point(x.lon, x.lat), axis <span class="op">=</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb11-64" title="64">    opportunitiesData <span class="op">=</span> gpd.GeoDataFrame(opportunitiesData, geometry <span class="op">=</span> geometry)</a>
<a class="sourceLine" id="cb11-65" title="65"></a>
<a class="sourceLine" id="cb11-66" title="66">    <span class="cf">return</span> opportunitiesData</a>
<a class="sourceLine" id="cb11-67" title="67">    </a>
<a class="sourceLine" id="cb11-68" title="68"><span class="kw">def</span> getProposalsData():</a>
<a class="sourceLine" id="cb11-69" title="69">    statusQuery <span class="op">=</span> Q(<span class="st">&quot;match&quot;</span>, proposalStatus <span class="op">=</span> <span class="st">&quot;OK&quot;</span>)</a>
<a class="sourceLine" id="cb11-70" title="70">    acceptedQuery <span class="op">=</span> Q(<span class="st">&quot;match&quot;</span>, proposalStage <span class="op">=</span> <span class="st">&quot;ACCEPTED&quot;</span>)</a>
<a class="sourceLine" id="cb11-71" title="71">    rejectedQuery <span class="op">=</span> Q(<span class="st">&quot;match&quot;</span>, proposalStage <span class="op">=</span> <span class="st">&quot;REJECTED&quot;</span>)</a>
<a class="sourceLine" id="cb11-72" title="72">    completeQuery <span class="op">=</span> statusQuery <span class="op">&amp;</span> (acceptedQuery <span class="op">|</span> rejectedQuery)</a>
<a class="sourceLine" id="cb11-73" title="73"></a>
<a class="sourceLine" id="cb11-74" title="74">    s1 <span class="op">=</span> Search(using<span class="op">=</span>es, index<span class="op">=</span><span class="st">&quot;proposal*&quot;</span>).source(includes<span class="op">=</span></a>
<a class="sourceLine" id="cb11-75" title="75">    [<span class="st">&quot;address.locality&quot;</span>,</a>
<a class="sourceLine" id="cb11-76" title="76">    <span class="st">&quot;address.administrativeAreaLevel2&quot;</span>,</a>
<a class="sourceLine" id="cb11-77" title="77">    <span class="st">&quot;address.postalCode&quot;</span>,</a>
<a class="sourceLine" id="cb11-78" title="78">    <span class="st">&quot;dateCheckIn&quot;</span>,</a>
<a class="sourceLine" id="cb11-79" title="79">    <span class="st">&quot;dateCheckOut&quot;</span>,</a>
<a class="sourceLine" id="cb11-80" title="80">    <span class="st">&quot;monthlyPriceDossier.amount&quot;</span>,</a>
<a class="sourceLine" id="cb11-81" title="81">    <span class="st">&quot;property.beds&quot;</span>,</a>
<a class="sourceLine" id="cb11-82" title="82">    <span class="st">&quot;proposalStage&quot;</span>,</a>
<a class="sourceLine" id="cb11-83" title="83">    <span class="st">&quot;proposalStatus&quot;</span>,</a>
<a class="sourceLine" id="cb11-84" title="84">    <span class="st">&quot;property.id&quot;</span>,</a>
<a class="sourceLine" id="cb11-85" title="85">    <span class="st">&quot;creationDate&quot;</span>,</a>
<a class="sourceLine" id="cb11-86" title="86">    <span class="st">&quot;address.geoLocation&quot;</span>]</a>
<a class="sourceLine" id="cb11-87" title="87">    ).query(<span class="st">&quot;bool&quot;</span>, <span class="bu">filter</span> <span class="op">=</span> completeQuery)</a>
<a class="sourceLine" id="cb11-88" title="88">    proposalsData <span class="op">=</span> pd.DataFrame((d.to_dict() <span class="cf">for</span> d <span class="kw">in</span> s1.scan()))</a>
<a class="sourceLine" id="cb11-89" title="89">    proposalsData <span class="op">=</span> proposalsData[(proposalsData.dateCheckIn <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;\</span></a>
<a class="sourceLine" id="cb11-90" title="90">    (proposalsData.dateCheckOut <span class="op">&gt;</span> <span class="dv">0</span>)]</a>
<a class="sourceLine" id="cb11-91" title="91">    proposalsData[<span class="st">&quot;propertyId&quot;</span>] <span class="op">=</span> proposalsData.<span class="bu">property</span>.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.get(<span class="st">&quot;id&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-92" title="92">    <span class="cf">if</span> <span class="bu">type</span>(x) <span class="kw">is</span> <span class="kw">not</span> <span class="bu">float</span> <span class="cf">else</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb11-93" title="93">    proposalsData[<span class="st">&quot;propertyCity&quot;</span>] <span class="op">=</span> proposalsData.address.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.get(<span class="st">&quot;locality&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-94" title="94">    <span class="cf">if</span> <span class="bu">type</span>(x) <span class="kw">is</span> <span class="kw">not</span> <span class="bu">float</span> <span class="cf">else</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb11-95" title="95">    proposalsData[<span class="st">&quot;province&quot;</span>] <span class="op">=</span> proposalsData.address.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.get<span class="op">\</span></a>
<a class="sourceLine" id="cb11-96" title="96">    (<span class="st">&quot;administrativeAreaLevel2&quot;</span>) <span class="cf">if</span> <span class="bu">type</span>(x) <span class="kw">is</span> <span class="kw">not</span> <span class="bu">float</span> <span class="cf">else</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb11-97" title="97">    proposalsData[<span class="st">&quot;monthlyPrice&quot;</span>] <span class="op">=</span> proposalsData.monthlyPriceDossier.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.get<span class="op">\</span></a>
<a class="sourceLine" id="cb11-98" title="98">    (<span class="st">&quot;amount&quot;</span>) <span class="cf">if</span> <span class="bu">type</span>(x) <span class="kw">is</span> <span class="kw">not</span> <span class="bu">float</span> <span class="cf">else</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb11-99" title="99">    proposalsData[<span class="st">&quot;dateCheckIn&quot;</span>] <span class="op">=</span> pd.to_datetime(proposalsData[<span class="st">&quot;dateCheckIn&quot;</span>], unit <span class="op">=</span> <span class="st">&quot;ms&quot;</span>)</a>
<a class="sourceLine" id="cb11-100" title="100">    proposalsData[<span class="st">&quot;dateCheckOut&quot;</span>] <span class="op">=</span> pd.to_datetime(proposalsData[<span class="st">&quot;dateCheckOut&quot;</span>], unit <span class="op">=</span> <span class="st">&quot;ms&quot;</span>)</a>
<a class="sourceLine" id="cb11-101" title="101">    proposalsData[<span class="st">&quot;beds&quot;</span>] <span class="op">=</span> proposalsData.<span class="bu">property</span>.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.get(<span class="st">&quot;beds&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-102" title="102">    <span class="cf">if</span> <span class="bu">type</span>(x) <span class="kw">is</span> <span class="kw">not</span> <span class="bu">float</span> <span class="cf">else</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb11-103" title="103">    proposalsData[<span class="st">&quot;duration&quot;</span>] <span class="op">=</span> (proposalsData[<span class="st">&quot;dateCheckOut&quot;</span>] <span class="op">-</span> proposalsData[<span class="st">&quot;dateCheckIn&quot;</span>])<span class="op">\</span></a>
<a class="sourceLine" id="cb11-104" title="104">    .dt.days</a>
<a class="sourceLine" id="cb11-105" title="105">    </a>
<a class="sourceLine" id="cb11-106" title="106">    proposalsData <span class="op">=</span> proposalsData.drop(</a>
<a class="sourceLine" id="cb11-107" title="107">    [<span class="st">&quot;property&quot;</span>,</a>
<a class="sourceLine" id="cb11-108" title="108">    <span class="st">&quot;proposalStatus&quot;</span>,</a>
<a class="sourceLine" id="cb11-109" title="109">    <span class="st">&quot;address&quot;</span>,</a>
<a class="sourceLine" id="cb11-110" title="110">    <span class="st">&quot;monthlyPriceDossier&quot;</span>,</a>
<a class="sourceLine" id="cb11-111" title="111">    <span class="st">&quot;creationDate&quot;</span>,</a>
<a class="sourceLine" id="cb11-112" title="112">    <span class="st">&quot;dateCheckIn&quot;</span>,</a>
<a class="sourceLine" id="cb11-113" title="113">    <span class="st">&quot;dateCheckOut&quot;</span>], axis<span class="op">=</span><span class="dv">1</span></a>
<a class="sourceLine" id="cb11-114" title="114">    )</a>
<a class="sourceLine" id="cb11-115" title="115">    proposalsData <span class="op">=</span> proposalsData.replace(<span class="st">&quot;Á&quot;</span>, <span class="st">&quot;A&quot;</span>).replace(<span class="st">&quot;á&quot;</span>, <span class="st">&quot;a&quot;</span>).replace(<span class="st">&quot;À&quot;</span>, <span class="st">&quot;A&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-116" title="116">    .replace(<span class="st">&quot;à&quot;</span>, <span class="st">&quot;a&quot;</span>).replace(<span class="st">&quot;É&quot;</span>, <span class="st">&quot;E&quot;</span>).replace(<span class="st">&quot;é&quot;</span>, <span class="st">&quot;e&quot;</span>).replace(<span class="st">&quot;È&quot;</span>, <span class="st">&quot;E&quot;</span>).replace(<span class="st">&quot;è&quot;</span>, <span class="st">&quot;e&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-117" title="117">    .replace(<span class="st">&quot;Í&quot;</span>, <span class="st">&quot;I&quot;</span>).replace(<span class="st">&quot;í&quot;</span>, <span class="st">&quot;i&quot;</span>).replace(<span class="st">&quot;Ì&quot;</span>, <span class="st">&quot;I&quot;</span>).replace(<span class="st">&quot;ì&quot;</span>, <span class="st">&quot;i&quot;</span>).replace(<span class="st">&quot;Ó&quot;</span>, <span class="st">&quot;O&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-118" title="118">    .replace(<span class="st">&quot;ó&quot;</span>, <span class="st">&quot;o&quot;</span>).replace(<span class="st">&quot;Ò&quot;</span>, <span class="st">&quot;O&quot;</span>).replace(<span class="st">&quot;ò&quot;</span>, <span class="st">&quot;o&quot;</span>).replace(<span class="st">&quot;Ú&quot;</span>,<span class="st">&quot;U&quot;</span>).replace(<span class="st">&quot;ú&quot;</span>, <span class="st">&quot;u&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-119" title="119">    .replace(<span class="st">&quot;Ù&quot;</span>, <span class="st">&quot;U&quot;</span>).replace(<span class="st">&quot;ù&quot;</span>, <span class="st">&quot;u&quot;</span>).replace(<span class="st">&quot;Ñ&quot;</span>, <span class="st">&quot;NY&quot;</span>).replace(<span class="st">&quot;ñ&quot;</span>, <span class="st">&quot;ny&quot;</span>).replace(<span class="st">&quot;Ü&quot;</span>, <span class="st">&quot;U&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb11-120" title="120">    .replace(<span class="st">&quot;ü&quot;</span>, <span class="st">&quot;u&quot;</span>)</a>
<a class="sourceLine" id="cb11-121" title="121">    </a>
<a class="sourceLine" id="cb11-122" title="122">    <span class="cf">return</span> proposalsData</a></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">def</span> getDistrictsFromDBX(zip_file_url):</a>
<a class="sourceLine" id="cb12-2" title="2">    zip_file_url <span class="op">=</span> zip_file_url</a>
<a class="sourceLine" id="cb12-3" title="3">    r <span class="op">=</span> requests.get(zip_file_url)</a>
<a class="sourceLine" id="cb12-4" title="4">    z <span class="op">=</span> zipfile.ZipFile(io.BytesIO(r.content))</a>
<a class="sourceLine" id="cb12-5" title="5">    z.extractall()</a>
<a class="sourceLine" id="cb12-6" title="6">    distritos <span class="op">=</span> gpd.GeoDataFrame.from_file(<span class="st">&quot;coordenadasDistritos.shp&quot;</span>)</a>
<a class="sourceLine" id="cb12-7" title="7">    distritos <span class="op">=</span> distritos.to_crs(epsg <span class="op">=</span> <span class="dv">4326</span>)</a>
<a class="sourceLine" id="cb12-8" title="8">    <span class="co"># distritos = distritos.replace(&quot;Araba/Álava&quot;, &quot;Álava&quot;)\</span></a>
<a class="sourceLine" id="cb12-9" title="9">    <span class="co"># .replace(&quot;Balears, Illes&quot;, &quot;Illes Balears&quot;)\</span></a>
<a class="sourceLine" id="cb12-10" title="10">    <span class="co"># .replace(&quot;Castellón/Castelló&quot;, &quot;Castellón&quot;)\</span></a>
<a class="sourceLine" id="cb12-11" title="11">    <span class="co"># .replace(&quot;Coruña, A&quot;, &quot;A Coruña&quot;)\</span></a>
<a class="sourceLine" id="cb12-12" title="12">    <span class="co"># .replace(&quot;Rioja, La&quot;, &quot;La Rioja&quot;)\</span></a>
<a class="sourceLine" id="cb12-13" title="13">    <span class="co"># .replace(&quot;Palmas, Las&quot;, &quot;Las Palmas&quot;)\</span></a>
<a class="sourceLine" id="cb12-14" title="14">    <span class="co"># .replace(&quot;Valencia/Valéncia&quot;, &quot;Valencia&quot;)</span></a>
<a class="sourceLine" id="cb12-15" title="15">    </a>
<a class="sourceLine" id="cb12-16" title="16">    <span class="cf">return</span> distritos</a>
<a class="sourceLine" id="cb12-17" title="17"></a>
<a class="sourceLine" id="cb12-18" title="18"><span class="kw">def</span> getPropertiesFromDBX(zip_file_url):</a>
<a class="sourceLine" id="cb12-19" title="19">    zip_file_url <span class="op">=</span> zip_file_url</a>
<a class="sourceLine" id="cb12-20" title="20">    r <span class="op">=</span> requests.get(zip_file_url)</a>
<a class="sourceLine" id="cb12-21" title="21">    z <span class="op">=</span> zipfile.ZipFile(io.BytesIO(r.content))</a>
<a class="sourceLine" id="cb12-22" title="22">    z.extractall()</a>
<a class="sourceLine" id="cb12-23" title="23">    propertiesGeometry <span class="op">=</span> gpd.GeoDataFrame.from_file(<span class="st">&quot;properties.shp&quot;</span>)</a>
<a class="sourceLine" id="cb12-24" title="24">    </a>
<a class="sourceLine" id="cb12-25" title="25">    <span class="cf">return</span> propertiesGeometry</a>
<a class="sourceLine" id="cb12-26" title="26">    </a>
<a class="sourceLine" id="cb12-27" title="27"><span class="kw">def</span> getOpportunitiesFromDBX(url):</a>
<a class="sourceLine" id="cb12-28" title="28">    opportunitiesDistritos <span class="op">=</span> pd.read_csv(url)</a>
<a class="sourceLine" id="cb12-29" title="29">    opportunitiesDistritos.drop(<span class="st">&quot;Unnamed: 0&quot;</span>, axis <span class="op">=</span> <span class="dv">1</span>, inplace <span class="op">=</span> <span class="va">True</span>)</a>
<a class="sourceLine" id="cb12-30" title="30">    </a>
<a class="sourceLine" id="cb12-31" title="31">    <span class="cf">return</span> opportunitiesDistritos</a></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">def</span> assignDistrictsToProperties(propertiesData):</a>
<a class="sourceLine" id="cb13-2" title="2"></a>
<a class="sourceLine" id="cb13-3" title="3">    propertiesGeometry <span class="op">=</span> getPropertiesFromDBX()</a>
<a class="sourceLine" id="cb13-4" title="4">    distritos <span class="op">=</span> getDistrictsFromDBX()</a>
<a class="sourceLine" id="cb13-5" title="5">    propertiesData <span class="op">=</span> propertiesData[<span class="op">~</span>propertiesData[<span class="st">&quot;propertyId&quot;</span>]<span class="op">\</span></a>
<a class="sourceLine" id="cb13-6" title="6">    .isin(propertiesGeometry[<span class="st">&quot;propertyId&quot;</span>])].reset_index()</a>
<a class="sourceLine" id="cb13-7" title="7">    </a>
<a class="sourceLine" id="cb13-8" title="8">    properties <span class="op">=</span> propertiesData.copy()</a>
<a class="sourceLine" id="cb13-9" title="9">    properties[<span class="st">&quot;distrito&quot;</span>] <span class="op">=</span> np.nan</a>
<a class="sourceLine" id="cb13-10" title="10">    properties[<span class="st">&quot;municipio&quot;</span>] <span class="op">=</span> np.nan</a>
<a class="sourceLine" id="cb13-11" title="11">    properties[<span class="st">&quot;polygon&quot;</span>] <span class="op">=</span> np.nan</a>
<a class="sourceLine" id="cb13-12" title="12">    length <span class="op">=</span> properties.shape[<span class="dv">0</span>]</a>
<a class="sourceLine" id="cb13-13" title="13">    totales <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb13-14" title="14">    sumat <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb13-15" title="15">    <span class="cf">for</span> i, inmueble <span class="kw">in</span> properties.iterrows():</a>
<a class="sourceLine" id="cb13-16" title="16">        provincia <span class="op">=</span> inmueble.province</a>
<a class="sourceLine" id="cb13-17" title="17">        point <span class="op">=</span> inmueble.geometry</a>
<a class="sourceLine" id="cb13-18" title="18">        distritosProvincia <span class="op">=</span> distritos[distritos.NPRO <span class="op">==</span> provincia]</a>
<a class="sourceLine" id="cb13-19" title="19">        <span class="cf">for</span> j, distrito <span class="kw">in</span> distritosProvincia.iterrows():</a>
<a class="sourceLine" id="cb13-20" title="20">            geom <span class="op">=</span> distrito.geometry</a>
<a class="sourceLine" id="cb13-21" title="21">            cudis <span class="op">=</span> distrito.CUDIS</a>
<a class="sourceLine" id="cb13-22" title="22">            nmun <span class="op">=</span> distrito.NMUN</a>
<a class="sourceLine" id="cb13-23" title="23">            <span class="cf">if</span> geom.contains(point):</a>
<a class="sourceLine" id="cb13-24" title="24">                properties[<span class="st">&quot;distrito&quot;</span>].loc[i] <span class="op">=</span> cudis</a>
<a class="sourceLine" id="cb13-25" title="25">                properties[<span class="st">&quot;municipio&quot;</span>].loc[i] <span class="op">=</span> nmun</a>
<a class="sourceLine" id="cb13-26" title="26">                properties[<span class="st">&quot;polygon&quot;</span>].loc[i] <span class="op">=</span> geom</a>
<a class="sourceLine" id="cb13-27" title="27">                <span class="cf">break</span></a>
<a class="sourceLine" id="cb13-28" title="28">            </a>
<a class="sourceLine" id="cb13-29" title="29">        totales <span class="op">+=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb13-30" title="30">        <span class="cf">if</span> totales <span class="op">==</span> <span class="dv">100</span>:</a>
<a class="sourceLine" id="cb13-31" title="31">            sumat <span class="op">+=</span> totales</a>
<a class="sourceLine" id="cb13-32" title="32">            totales <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb13-33" title="33">            <span class="bu">print</span>(<span class="bu">str</span>(sumat) <span class="op">+</span> <span class="st">&quot; completados de &quot;</span> <span class="op">+</span> <span class="bu">str</span>(length))</a>
<a class="sourceLine" id="cb13-34" title="34">    </a>
<a class="sourceLine" id="cb13-35" title="35">    properties.drop(columns<span class="op">=</span>[<span class="st">&quot;geometry&quot;</span>, <span class="st">&quot;index&quot;</span>], inplace <span class="op">=</span> <span class="va">True</span>)</a>
<a class="sourceLine" id="cb13-36" title="36">    properties.rename(columns<span class="op">=</span>{<span class="st">&quot;polygon&quot;</span>: <span class="st">&quot;geometry&quot;</span>}, inplace <span class="op">=</span> <span class="va">True</span>)</a>
<a class="sourceLine" id="cb13-37" title="37">    properties <span class="op">=</span> gpd.GeoDataFrame(properties, geometry <span class="op">=</span> properties.geometry)</a>
<a class="sourceLine" id="cb13-38" title="38">    properties <span class="op">=</span> properties[[<span class="st">&quot;propertyId&quot;</span>, <span class="st">&quot;municipio&quot;</span>, <span class="st">&quot;distrito&quot;</span>, <span class="st">&quot;geometry&quot;</span>]]</a>
<a class="sourceLine" id="cb13-39" title="39">    </a>
<a class="sourceLine" id="cb13-40" title="40">    properties <span class="op">=</span> pd.concat([propertiesGeometry, properties], sort <span class="op">=</span> <span class="va">True</span>)</a>
<a class="sourceLine" id="cb13-41" title="41">    properties <span class="op">=</span> properties.drop_duplicates(subset <span class="op">=</span> <span class="st">&quot;propertyId&quot;</span>)</a>
<a class="sourceLine" id="cb13-42" title="42">    </a>
<a class="sourceLine" id="cb13-43" title="43">    <span class="cf">return</span> properties</a>
<a class="sourceLine" id="cb13-44" title="44"></a>
<a class="sourceLine" id="cb13-45" title="45"></a>
<a class="sourceLine" id="cb13-46" title="46"><span class="kw">def</span> assignDistrictsToOpportunities(opportunitiesData):</a>
<a class="sourceLine" id="cb13-47" title="47">    opportunitiesDistritos <span class="op">=</span> getOpportunitiesFromDBX(url)</a>
<a class="sourceLine" id="cb13-48" title="48">    opportunitiesData <span class="op">=</span> opportunitiesData[<span class="op">~</span>opportunitiesData[<span class="st">&quot;id&quot;</span>]<span class="op">\</span></a>
<a class="sourceLine" id="cb13-49" title="49">    .isin(opportunitiesDistritos[<span class="st">&quot;id&quot;</span>])].reset_index()</a>
<a class="sourceLine" id="cb13-50" title="50">    opportunitiesData.drop(columns<span class="op">=</span>[<span class="st">&quot;index&quot;</span>], inplace<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb13-51" title="51">    distritos <span class="op">=</span> gpd.GeoDataFrame.from_file(<span class="st">&quot;coordenadasDistritos.shp&quot;</span>)</a>
<a class="sourceLine" id="cb13-52" title="52">    distritos <span class="op">=</span> distritos.to_crs(epsg <span class="op">=</span> <span class="dv">4326</span>)</a>
<a class="sourceLine" id="cb13-53" title="53">    <span class="co"># distritos = distritos.replace(&quot;Araba/Álava&quot;, &quot;Álava&quot;)\</span></a>
<a class="sourceLine" id="cb13-54" title="54">    <span class="co"># .replace(&#39;Balears, Illes&#39;, &quot;Illes Balears&quot;)\</span></a>
<a class="sourceLine" id="cb13-55" title="55">    <span class="co"># .replace(&#39;Castellón/Castelló&#39;, &quot;Castellón&quot;)\</span></a>
<a class="sourceLine" id="cb13-56" title="56">    <span class="co"># .replace(&#39;Coruña, A&#39;, &quot;A Coruña&quot;)\</span></a>
<a class="sourceLine" id="cb13-57" title="57">    <span class="co"># .replace(&#39;Rioja, La&#39;, &quot;La Rioja&quot;)\</span></a>
<a class="sourceLine" id="cb13-58" title="58">    <span class="co"># .replace(&#39;Palmas, Las&#39;, &quot;Las Palmas&quot;)\</span></a>
<a class="sourceLine" id="cb13-59" title="59">    <span class="co"># .replace(&#39;Valencia/Valéncia&#39;, &quot;Valencia&quot;)</span></a>
<a class="sourceLine" id="cb13-60" title="60">    </a>
<a class="sourceLine" id="cb13-61" title="61">    opportunities <span class="op">=</span> opportunitiesData.copy()</a>
<a class="sourceLine" id="cb13-62" title="62">    opportunities[<span class="st">&quot;distrito&quot;</span>] <span class="op">=</span> np.nan</a>
<a class="sourceLine" id="cb13-63" title="63">    opportunities[<span class="st">&quot;municipio&quot;</span>] <span class="op">=</span> np.nan</a>
<a class="sourceLine" id="cb13-64" title="64">    length <span class="op">=</span> opportunities.shape[<span class="dv">0</span>]</a>
<a class="sourceLine" id="cb13-65" title="65">    totales <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb13-66" title="66">    sumat <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb13-67" title="67">    <span class="cf">for</span> i, opportunity <span class="kw">in</span> opportunities.iterrows():</a>
<a class="sourceLine" id="cb13-68" title="68">        provincia <span class="op">=</span> opportunity.province</a>
<a class="sourceLine" id="cb13-69" title="69">        point <span class="op">=</span> opportunity.geometry</a>
<a class="sourceLine" id="cb13-70" title="70">        distritosProvincia <span class="op">=</span> distritos[distritos.NPRO <span class="op">==</span> provincia]</a>
<a class="sourceLine" id="cb13-71" title="71">        <span class="cf">for</span> j, distrito <span class="kw">in</span> distritosProvincia.iterrows():</a>
<a class="sourceLine" id="cb13-72" title="72">            geom <span class="op">=</span> distrito.geometry</a>
<a class="sourceLine" id="cb13-73" title="73">            cudis <span class="op">=</span> distrito.CUDIS</a>
<a class="sourceLine" id="cb13-74" title="74">            nmun <span class="op">=</span> distrito.NMUN</a>
<a class="sourceLine" id="cb13-75" title="75">            <span class="cf">if</span> geom.contains(point):</a>
<a class="sourceLine" id="cb13-76" title="76">                opportunities[<span class="st">&quot;distrito&quot;</span>].loc[i] <span class="op">=</span> cudis</a>
<a class="sourceLine" id="cb13-77" title="77">                opportunities[<span class="st">&quot;municipio&quot;</span>].loc[i] <span class="op">=</span> nmun</a>
<a class="sourceLine" id="cb13-78" title="78">                <span class="cf">break</span></a>
<a class="sourceLine" id="cb13-79" title="79">            </a>
<a class="sourceLine" id="cb13-80" title="80">        totales <span class="op">+=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb13-81" title="81">        <span class="cf">if</span> totales <span class="op">==</span> <span class="dv">100</span>:</a>
<a class="sourceLine" id="cb13-82" title="82">            sumat <span class="op">+=</span> totales</a>
<a class="sourceLine" id="cb13-83" title="83">            totales <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb13-84" title="84">            <span class="bu">print</span>(<span class="bu">str</span>(sumat) <span class="op">+</span> <span class="st">&quot; completados de &quot;</span> <span class="op">+</span> <span class="bu">str</span>(length))</a>
<a class="sourceLine" id="cb13-85" title="85">    opportunities.drop(columns<span class="op">=</span>[<span class="st">&quot;geometry&quot;</span>, <span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>], inplace <span class="op">=</span> <span class="va">True</span>)</a>
<a class="sourceLine" id="cb13-86" title="86">    opportunities[<span class="st">&quot;distrito&quot;</span>] <span class="op">=</span> opportunities.distrito.astype(<span class="bu">str</span>)</a>
<a class="sourceLine" id="cb13-87" title="87">    opportunities[<span class="st">&quot;distrito&quot;</span>] <span class="op">=</span> opportunities.distrito <span class="op">+</span> <span class="st">&quot;x&quot;</span></a>
<a class="sourceLine" id="cb13-88" title="88">    opportunities <span class="op">=</span> pd.concat([opportunitiesDistritos, opportunities], sort <span class="op">=</span> <span class="va">True</span>)</a>
<a class="sourceLine" id="cb13-89" title="89">    </a>
<a class="sourceLine" id="cb13-90" title="90">    <span class="cf">return</span> opportunities</a>
<a class="sourceLine" id="cb13-91" title="91">    </a>
<a class="sourceLine" id="cb13-92" title="92"><span class="kw">def</span> assignDistrictsToProposals(proposalsData):</a>
<a class="sourceLine" id="cb13-93" title="93">    properties <span class="op">=</span> getPropertiesFromDBX()</a>
<a class="sourceLine" id="cb13-94" title="94">    proposalsData <span class="op">=</span> proposalsData.merge(properties, how <span class="op">=</span> <span class="st">&quot;left&quot;</span>, on <span class="op">=</span> <span class="st">&quot;propertyId&quot;</span>)</a>
<a class="sourceLine" id="cb13-95" title="95">    proposalsData <span class="op">=</span> gpd.GeoDataFrame(proposalsData, geometry <span class="op">=</span> proposalsData.geometry)</a>
<a class="sourceLine" id="cb13-96" title="96">    </a>
<a class="sourceLine" id="cb13-97" title="97">    <span class="cf">return</span> proposalsData</a></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb14-1" title="1"><span class="kw">def</span> groupByDistricts(proposalsData):</a>
<a class="sourceLine" id="cb14-2" title="2">    opportunities <span class="op">=</span> getOpportunitiesFromDBX()</a>
<a class="sourceLine" id="cb14-3" title="3">    </a>
<a class="sourceLine" id="cb14-4" title="4">    pricePerRooms <span class="op">=</span> proposalsData.dropna(subset<span class="op">=</span>[<span class="st">&quot;monthlyPrice&quot;</span>]).groupby([<span class="st">&quot;distrito&quot;</span>, <span class="st">&quot;rooms&quot;</span>])<span class="op">\</span></a>
<a class="sourceLine" id="cb14-5" title="5">    [<span class="st">&quot;monthlyPrice&quot;</span>].median().reset_index()<span class="op">\</span></a>
<a class="sourceLine" id="cb14-6" title="6">    .pivot(index <span class="op">=</span> <span class="st">&quot;distrito&quot;</span>, columns <span class="op">=</span> <span class="st">&quot;rooms&quot;</span>, values <span class="op">=</span> <span class="st">&quot;monthlyPrice&quot;</span>).reset_index()</a>
<a class="sourceLine" id="cb14-7" title="7">    </a>
<a class="sourceLine" id="cb14-8" title="8">    proposalsNumber <span class="op">=</span> proposalsData.groupby(<span class="st">&quot;distrito&quot;</span>)[<span class="st">&quot;proposalStage&quot;</span>].count().reset_index()<span class="op">\</span></a>
<a class="sourceLine" id="cb14-9" title="9">    .sort_values(by<span class="op">=</span><span class="st">&quot;proposalStage&quot;</span>, ascending <span class="op">=</span> <span class="va">False</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb14-10" title="10">    .rename(columns <span class="op">=</span> {<span class="st">&quot;proposalStage&quot;</span>: <span class="st">&quot;proposalsNumber&quot;</span>})</a>
<a class="sourceLine" id="cb14-11" title="11">    </a>
<a class="sourceLine" id="cb14-12" title="12">    propertiesProposedPerDistrict <span class="op">=</span> proposalsData.groupby(<span class="st">&quot;distrito&quot;</span>)[<span class="st">&quot;propertyId&quot;</span>]<span class="op">\</span></a>
<a class="sourceLine" id="cb14-13" title="13">    .nunique().reset_index().rename(columns <span class="op">=</span> {<span class="st">&quot;propertyId&quot;</span>: <span class="st">&quot;numberPropertiesProposed&quot;</span>})</a>
<a class="sourceLine" id="cb14-14" title="14">    </a>
<a class="sourceLine" id="cb14-15" title="15">    propertiesAcceptedPerDistrict <span class="op">=</span> proposalsData[proposalsData.proposalStage <span class="op">==</span> <span class="st">&quot;ACCEPTED&quot;</span>]<span class="op">\</span></a>
<a class="sourceLine" id="cb14-16" title="16">    .groupby(<span class="st">&quot;distrito&quot;</span>)[<span class="st">&quot;propertyId&quot;</span>].nunique().reset_index()<span class="op">\</span></a>
<a class="sourceLine" id="cb14-17" title="17">    .rename(columns <span class="op">=</span> {<span class="st">&quot;propertyId&quot;</span>: <span class="st">&quot;numberPropertiesAccepted&quot;</span>})</a>
<a class="sourceLine" id="cb14-18" title="18">    </a>
<a class="sourceLine" id="cb14-19" title="19">    propertiesPerDistrict <span class="op">=</span> properties[[<span class="st">&quot;distrito&quot;</span>, <span class="st">&quot;propertyId&quot;</span>]]<span class="op">\</span></a>
<a class="sourceLine" id="cb14-20" title="20">    .groupby(<span class="st">&quot;distrito&quot;</span>).count().reset_index().rename(columns<span class="op">=</span>{<span class="st">&quot;propertyId&quot;</span>: <span class="st">&quot;numberProperties&quot;</span>})</a>
<a class="sourceLine" id="cb14-21" title="21">    </a>
<a class="sourceLine" id="cb14-22" title="22">    acceptedProposalsNumber <span class="op">=</span> proposalsData[proposalsData.proposalStage <span class="op">==</span> <span class="st">&quot;ACCEPTED&quot;</span>]<span class="op">\</span></a>
<a class="sourceLine" id="cb14-23" title="23">    .groupby(<span class="st">&quot;distrito&quot;</span>)[<span class="st">&quot;proposalStage&quot;</span>].count().reset_index()<span class="op">\</span></a>
<a class="sourceLine" id="cb14-24" title="24">    .sort_values(by<span class="op">=</span><span class="st">&quot;proposalStage&quot;</span>, ascending <span class="op">=</span> <span class="va">False</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb14-25" title="25">    .rename(columns <span class="op">=</span> {<span class="st">&quot;proposalStage&quot;</span>: <span class="st">&quot;acceptedProposalsNumber&quot;</span>})</a>
<a class="sourceLine" id="cb14-26" title="26">    </a>
<a class="sourceLine" id="cb14-27" title="27">    durationPerDistrict <span class="op">=</span> proposalsData.groupby(<span class="st">&quot;distrito&quot;</span>)[<span class="st">&quot;duration&quot;</span>].median().reset_index()</a>
<a class="sourceLine" id="cb14-28" title="28">    </a>
<a class="sourceLine" id="cb14-29" title="29">    opportunitiesPerDistrict <span class="op">=</span> opportunities.groupby(<span class="st">&quot;distrito&quot;</span>)[<span class="st">&quot;id&quot;</span>].count().reset_index()<span class="op">\</span></a>
<a class="sourceLine" id="cb14-30" title="30">    .rename(columns<span class="op">=</span>{<span class="st">&quot;id&quot;</span>: <span class="st">&quot;numOpportunities&quot;</span>})<span class="op">\</span></a>
<a class="sourceLine" id="cb14-31" title="31">    .sort_values(ascending <span class="op">=</span> <span class="va">False</span>, by <span class="op">=</span> <span class="st">&quot;numOpportunities&quot;</span>)</a>
<a class="sourceLine" id="cb14-32" title="32">    </a>
<a class="sourceLine" id="cb14-33" title="33">    bookingsPerDistrict <span class="op">=</span> opportunities<span class="op">\</span></a>
<a class="sourceLine" id="cb14-34" title="34">    [(opportunities.rentalRequestStage <span class="op">==</span> <span class="st">&quot;S030_CONTRACT_INVOICE_MANAGMENT&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb14-35" title="35">    <span class="op">|</span> (opportunities.rentalRequestStage <span class="op">==</span><span class="st">&quot;S040_CHECK_IN&quot;</span>) <span class="op">|</span> <span class="op">\</span></a>
<a class="sourceLine" id="cb14-36" title="36">    (opportunities.rentalRequestStage <span class="op">==</span> <span class="st">&quot;S050_RENTAL_CONFIRMED&quot;</span>) <span class="op">|</span> <span class="op">\</span></a>
<a class="sourceLine" id="cb14-37" title="37">    (opportunities.rentalRequestStage <span class="op">==</span><span class="st">&quot;S060_CONVERSION_HISTORY&quot;</span>)]<span class="op">\</span></a>
<a class="sourceLine" id="cb14-38" title="38">    .groupby(<span class="st">&quot;distrito&quot;</span>)[<span class="st">&quot;id&quot;</span>].count().reset_index().rename(columns<span class="op">=</span>{<span class="st">&quot;id&quot;</span>: <span class="st">&quot;numBookings&quot;</span>})<span class="op">\</span></a>
<a class="sourceLine" id="cb14-39" title="39">    .sort_values(ascending <span class="op">=</span> <span class="va">False</span>, by <span class="op">=</span> <span class="st">&quot;numBookings&quot;</span>)</a>
<a class="sourceLine" id="cb14-40" title="40">    </a>
<a class="sourceLine" id="cb14-41" title="41">    distritos <span class="op">=</span> proposalsData[[<span class="st">&quot;distrito&quot;</span>, <span class="st">&quot;geometry&quot;</span>, <span class="st">&quot;municipio&quot;</span>, <span class="st">&quot;propertyCity&quot;</span>]]<span class="op">\</span></a>
<a class="sourceLine" id="cb14-42" title="42">    .drop_duplicates(subset <span class="op">=</span> <span class="st">&quot;distrito&quot;</span>)</a>
<a class="sourceLine" id="cb14-43" title="43">    </a>
<a class="sourceLine" id="cb14-44" title="44">    heatmap_data <span class="op">=</span> proposalsNumber.merge(acceptedProposalsNumber, how <span class="op">=</span> <span class="st">&quot;left&quot;</span>, on <span class="op">=</span><span class="st">&quot;distrito&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb14-45" title="45">    .merge(propertiesPerDistrict, how <span class="op">=</span> <span class="st">&quot;left&quot;</span>, on <span class="op">=</span> <span class="st">&quot;distrito&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb14-46" title="46">    .merge(propertiesProposedPerDistrict, how <span class="op">=</span> <span class="st">&quot;left&quot;</span>, on <span class="op">=</span> <span class="st">&quot;distrito&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb14-47" title="47">    .merge(propertiesAcceptedPerDistrict, how <span class="op">=</span> <span class="st">&quot;left&quot;</span>, on <span class="op">=</span> <span class="st">&quot;distrito&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb14-48" title="48">    .merge(durationPerDistrict, how <span class="op">=</span> <span class="st">&quot;left&quot;</span>, on <span class="op">=</span> <span class="st">&quot;distrito&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb14-49" title="49">    .merge(pricePerRooms, how <span class="op">=</span> <span class="st">&quot;left&quot;</span>, on <span class="op">=</span> <span class="st">&quot;distrito&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb14-50" title="50">    .merge(opportunitiesPerDistrict, how <span class="op">=</span> <span class="st">&quot;left&quot;</span>, on <span class="op">=</span> <span class="st">&quot;distrito&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb14-51" title="51">    .merge(bookingsPerDistrict, how <span class="op">=</span> <span class="st">&quot;left&quot;</span>, on <span class="op">=</span> <span class="st">&quot;distrito&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb14-52" title="52">    .merge(distritos, how <span class="op">=</span> <span class="st">&quot;left&quot;</span>, on <span class="op">=</span> <span class="st">&quot;distrito&quot;</span>)<span class="op">\</span></a>
<a class="sourceLine" id="cb14-53" title="53">    </a>
<a class="sourceLine" id="cb14-54" title="54">    heatmap_data <span class="op">=</span> gpd.GeoDataFrame(heatmap_data, geometry <span class="op">=</span> heatmap_data.geometry)</a>
<a class="sourceLine" id="cb14-55" title="55">    heatmap_data[<span class="st">&quot;conversionRatio&quot;</span>] <span class="op">=</span> heatmap_data[<span class="st">&quot;numBookings&quot;</span>]<span class="op">\</span></a>
<a class="sourceLine" id="cb14-56" title="56">    <span class="op">/</span>heatmap_data[<span class="st">&quot;numOpportunities&quot;</span>]</a>
<a class="sourceLine" id="cb14-57" title="57">    heatmap_data[<span class="st">&quot;benchmark&quot;</span>] <span class="op">=</span> heatmap_data[<span class="st">&quot;acceptedProposalsNumber&quot;</span>]<span class="op">\</span></a>
<a class="sourceLine" id="cb14-58" title="58">    <span class="op">/</span>heatmap_data[<span class="st">&quot;proposalsNumber&quot;</span>]</a>
<a class="sourceLine" id="cb14-59" title="59">    heatmap_data[<span class="st">&quot;propertiesUsed&quot;</span>] <span class="op">=</span> heatmap_data[<span class="st">&quot;numberPropertiesProposed&quot;</span>]<span class="op">\</span></a>
<a class="sourceLine" id="cb14-60" title="60">    <span class="op">/</span>heatmap_data[<span class="st">&quot;numberProperties&quot;</span>]</a>
<a class="sourceLine" id="cb14-61" title="61">    heatmap_data[<span class="st">&quot;propertiesConverted&quot;</span>] <span class="op">=</span> heatmap_data[<span class="st">&quot;numberPropertiesAccepted&quot;</span>]<span class="op">\</span></a>
<a class="sourceLine" id="cb14-62" title="62">    <span class="op">/</span>heatmap_data[<span class="st">&quot;numberPropertiesProposed&quot;</span>]</a>
<a class="sourceLine" id="cb14-63" title="63">    </a>
<a class="sourceLine" id="cb14-64" title="64">    heatmap_data[<span class="st">&quot;distrito&quot;</span>] <span class="op">=</span> heatmap_data.distrito.astype(<span class="bu">str</span>)</a>
<a class="sourceLine" id="cb14-65" title="65">    </a>
<a class="sourceLine" id="cb14-66" title="66">    <span class="cf">return</span> heatmap_data</a></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb15-1" title="1"><span class="co"># Access token</span></a>
<a class="sourceLine" id="cb15-2" title="2">TOKEN <span class="op">=</span> TOKEN</a>
<a class="sourceLine" id="cb15-3" title="3"></a>
<a class="sourceLine" id="cb15-4" title="4"><span class="co"># Uploads contents of LOCALFILE to Dropbox</span></a>
<a class="sourceLine" id="cb15-5" title="5"><span class="kw">def</span> backup():</a>
<a class="sourceLine" id="cb15-6" title="6">    <span class="cf">with</span> <span class="bu">open</span>(LOCALFILE, <span class="st">&#39;rb&#39;</span>) <span class="im">as</span> f:</a>
<a class="sourceLine" id="cb15-7" title="7">        <span class="bu">print</span>(<span class="st">&quot;Uploading &quot;</span> <span class="op">+</span> LOCALFILE <span class="op">+</span> <span class="st">&quot; to Dropbox as &quot;</span> <span class="op">+</span> BACKUPPATH <span class="op">+</span> <span class="st">&quot;...&quot;</span>)</a>
<a class="sourceLine" id="cb15-8" title="8">        <span class="cf">try</span>:</a>
<a class="sourceLine" id="cb15-9" title="9">          dbx <span class="op">=</span> dropbox.Dropbox(TOKEN)</a>
<a class="sourceLine" id="cb15-10" title="10">          dbx.files_upload(f.read(), BACKUPPATH, mode<span class="op">=</span>WriteMode(<span class="st">&#39;overwrite&#39;</span>))</a>
<a class="sourceLine" id="cb15-11" title="11">        <span class="cf">except</span> ApiError <span class="im">as</span> err:</a>
<a class="sourceLine" id="cb15-12" title="12">            <span class="cf">if</span> err.user_message_text:</a>
<a class="sourceLine" id="cb15-13" title="13">                <span class="bu">print</span>(err.user_message_text)</a>
<a class="sourceLine" id="cb15-14" title="14">                sys.exit()</a>
<a class="sourceLine" id="cb15-15" title="15">            <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb15-16" title="16">                <span class="bu">print</span>(err)</a>
<a class="sourceLine" id="cb15-17" title="17">                sys.exit()</a>
<a class="sourceLine" id="cb15-18" title="18"></a>
<a class="sourceLine" id="cb15-19" title="19"></a>
<a class="sourceLine" id="cb15-20" title="20"><span class="co"># Adding few functions to check file details</span></a>
<a class="sourceLine" id="cb15-21" title="21"><span class="kw">def</span> checkFileDetails():</a>
<a class="sourceLine" id="cb15-22" title="22">    <span class="bu">print</span>(<span class="st">&quot;Checking file details&quot;</span>)</a>
<a class="sourceLine" id="cb15-23" title="23"></a>
<a class="sourceLine" id="cb15-24" title="24">    <span class="cf">for</span> entry <span class="kw">in</span> dbx.files_list_folder(<span class="st">&#39;&#39;</span>).entries:</a>
<a class="sourceLine" id="cb15-25" title="25">        <span class="bu">print</span>(<span class="st">&quot;File list is : &quot;</span>)</a>
<a class="sourceLine" id="cb15-26" title="26">        <span class="bu">print</span>(entry.name)</a>
<a class="sourceLine" id="cb15-27" title="27"></a>
<a class="sourceLine" id="cb15-28" title="28"></a>
<a class="sourceLine" id="cb15-29" title="29"><span class="co"># Run this script independently</span></a>
<a class="sourceLine" id="cb15-30" title="30"><span class="kw">def</span> uploadDropbox(TOKEN, LOCALFILE, BACKUPPATH):</a>
<a class="sourceLine" id="cb15-31" title="31">  <span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</a>
<a class="sourceLine" id="cb15-32" title="32">    <span class="co"># Check for an access token</span></a>
<a class="sourceLine" id="cb15-33" title="33">    <span class="cf">if</span> (<span class="bu">len</span>(TOKEN) <span class="op">==</span> <span class="dv">0</span>):</a>
<a class="sourceLine" id="cb15-34" title="34">        sys.exit(<span class="st">&quot;ERROR: Looks like you didn&#39;t add your access token.\</span></a>
<a class="sourceLine" id="cb15-35" title="35"><span class="st">        Open up backup-and-restore-example.py in a text editor and paste in your token in line 14.&quot;</span>)</a>
<a class="sourceLine" id="cb15-36" title="36"></a>
<a class="sourceLine" id="cb15-37" title="37">    <span class="co"># Create an instance of a Dropbox class, which can make requests to the API.</span></a>
<a class="sourceLine" id="cb15-38" title="38">    <span class="bu">print</span>(<span class="st">&quot;Creating a Dropbox object...&quot;</span>)</a>
<a class="sourceLine" id="cb15-39" title="39">    dbx <span class="op">=</span> dropbox.Dropbox(TOKEN)</a>
<a class="sourceLine" id="cb15-40" title="40">    <span class="bu">print</span>(<span class="st">&quot;Creating backup...&quot;</span>)</a>
<a class="sourceLine" id="cb15-41" title="41">    <span class="co"># Create a backup of the current settings file</span></a>
<a class="sourceLine" id="cb15-42" title="42">    backup()</a>
<a class="sourceLine" id="cb15-43" title="43">    <span class="bu">print</span>(<span class="st">&quot;Done!&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb16-1" title="1"><span class="kw">def</span> savePropertiesToDBX(properties):</a>
<a class="sourceLine" id="cb16-2" title="2">    properties.to_file(<span class="st">&quot;properties.shp&quot;</span>)</a>
<a class="sourceLine" id="cb16-3" title="3">    </a>
<a class="sourceLine" id="cb16-4" title="4">    filename <span class="op">=</span> <span class="st">&quot;properties.zip&quot;</span></a>
<a class="sourceLine" id="cb16-5" title="5">    <span class="cf">with</span> ZipFile(filename, <span class="st">&quot;w&quot;</span>) <span class="im">as</span> <span class="bu">zip</span>:</a>
<a class="sourceLine" id="cb16-6" title="6">        <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> [<span class="st">&quot;properties.shp&quot;</span>, <span class="st">&quot;properties.cpg&quot;</span>, <span class="st">&quot;properties.dbf&quot;</span>, <span class="st">&quot;properties.shx&quot;</span>]:</a>
<a class="sourceLine" id="cb16-7" title="7">            <span class="bu">zip</span>.write(<span class="bu">file</span>)</a>
<a class="sourceLine" id="cb16-8" title="8">    </a>
<a class="sourceLine" id="cb16-9" title="9">    LOCALFILE <span class="op">=</span> <span class="st">&quot;properties.zip&quot;</span></a>
<a class="sourceLine" id="cb16-10" title="10">    BACKUPPATH <span class="op">=</span> <span class="st">&quot;/properties.zip&quot;</span></a>
<a class="sourceLine" id="cb16-11" title="11">    uploadDropbox(TOKEN, LOCALFILE, BACKUPPATH)</a>
<a class="sourceLine" id="cb16-12" title="12">    </a>
<a class="sourceLine" id="cb16-13" title="13"><span class="kw">def</span> saveOpportunitiesToDBX(opportunities):</a>
<a class="sourceLine" id="cb16-14" title="14">    opportunities.to_csv(<span class="st">&quot;opportunities.csv&quot;</span>)</a>
<a class="sourceLine" id="cb16-15" title="15">    LOCALFILE <span class="op">=</span> <span class="st">&quot;opportunities.csv&quot;</span></a>
<a class="sourceLine" id="cb16-16" title="16">    BACKUPPATH <span class="op">=</span> <span class="st">&quot;/opportunities.csv&quot;</span></a>
<a class="sourceLine" id="cb16-17" title="17">    uploadDropbox(TOKEN, LOCALFILE, BACKUPPATH)</a>
<a class="sourceLine" id="cb16-18" title="18">    </a>
<a class="sourceLine" id="cb16-19" title="19"><span class="kw">def</span> saveHeatmapToDBX(heatmap_data):</a>
<a class="sourceLine" id="cb16-20" title="20">    heatmap_data.to_file(<span class="st">&quot;heatmap.shp&quot;</span>)</a>
<a class="sourceLine" id="cb16-21" title="21">    </a>
<a class="sourceLine" id="cb16-22" title="22">    filename <span class="op">=</span> <span class="st">&quot;heatmap.zip&quot;</span></a>
<a class="sourceLine" id="cb16-23" title="23">    <span class="cf">with</span> ZipFile(filename, <span class="st">&quot;w&quot;</span>) <span class="im">as</span> <span class="bu">zip</span>:</a>
<a class="sourceLine" id="cb16-24" title="24">        <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> [<span class="st">&quot;heatmap.shp&quot;</span>, <span class="st">&quot;heatmap.cpg&quot;</span>, <span class="st">&quot;heatmap.dbf&quot;</span>, <span class="st">&quot;heatmap.shx&quot;</span>]:</a>
<a class="sourceLine" id="cb16-25" title="25">            <span class="bu">zip</span>.write(<span class="bu">file</span>)</a>
<a class="sourceLine" id="cb16-26" title="26">    </a>
<a class="sourceLine" id="cb16-27" title="27">    LOCALFILE <span class="op">=</span> <span class="st">&quot;heatmap.zip&quot;</span></a>
<a class="sourceLine" id="cb16-28" title="28">    BACKUPPATH <span class="op">=</span> <span class="st">&quot;/heatmap.zip&quot;</span></a>
<a class="sourceLine" id="cb16-29" title="29">    uploadDropbox(TOKEN, LOCALFILE, BACKUPPATH)</a>
<a class="sourceLine" id="cb16-30" title="30">    </a>
<a class="sourceLine" id="cb16-31" title="31"><span class="kw">def</span> saveProposalsToDBX(proposalsData):</a>
<a class="sourceLine" id="cb16-32" title="32">    proposalsData.drop(columns<span class="op">=</span>[<span class="st">&quot;geometry&quot;</span>], inplace <span class="op">=</span> <span class="va">True</span>)</a>
<a class="sourceLine" id="cb16-33" title="33">    proposalsData[<span class="st">&quot;distrito&quot;</span>] <span class="op">=</span> proposalsData.distrito.astype(<span class="bu">str</span>)</a>
<a class="sourceLine" id="cb16-34" title="34">    </a>
<a class="sourceLine" id="cb16-35" title="35">    proposalsData.to_csv(<span class="st">&quot;proposalsData.csv&quot;</span>)</a>
<a class="sourceLine" id="cb16-36" title="36">    LOCALFILE <span class="op">=</span> <span class="st">&quot;proposalsData.csv&quot;</span></a>
<a class="sourceLine" id="cb16-37" title="37">    BACKUPPATH <span class="op">=</span> <span class="st">&quot;/proposalsData.csv&quot;</span></a>
<a class="sourceLine" id="cb16-38" title="38">    uploadDropbox(TOKEN, LOCALFILE, BACKUPPATH)</a></code></pre></div>

</div>
            </section>

          </div>
        </div>
      </div>
<a href="código.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="desarrollo-de-la-aplicación-en-shiny-1.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
